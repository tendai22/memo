# MEZ6303R ... Mezzanine Board for HD6303R MPU

手持ちのHD6303Rを活かす。ということでメザニン基板を作ることを考える。論点は例によって以下の6本である。例によってMPU/SRAM/PICの3チップ構成とし、シリアルI/OはPIC側シリアルを充てる。

1. 当初の端子割り当て
2. シングルステップ
1. PICリセット/PICファーム書き込み時の挙動
2. ブートローディング、SRAMへのバイナリ書き込み
3. I/Oポート
4. メモリアクセス制御

## 当初の端子割り当て案

|HD6303R端子|PIC端子|コメント|
|EXTAL(3)|CLK(6)|外部クロックによる駆動|
|XTAL(2)|NC|open|
|NMI(4)|RD(21)-RA5|シングルステップのレジスタ読み出しに使用|
|IRQ(5)|pull up||
|RES(6)|RESET(26)-RE1||
|STBY(7)|pull up||
|P20(8)|pull up|H...choose multiplex mode|
|P21(9)|pull down|L...choose multiplex mode
|P22(10)|pull down|L...choose multiplex mode|
|P23(11)|NC|SCI-RX...serial RX pin|
|P24(12)|NC|SCI-TX...serial TX pin|
|A0/P10(13)-<br>A7/P17(20)|A0-A7|address bus low|
|A8(29)-A15(21)|A8-A15|address bus high|
|D0/A0(37)-D7/A7(30)|D0-D7|data bus|
|R/W(38)|IORQ(20)-RA0||
|AS(39)|RFSH(28)-RA2||
|E(40)|MREQ(19)-RA1||

* 内蔵シリアル(SCI)を使う前提で考えると、丁度P23,P24がRX,TXになる。
* P20,P21,P22はモード選択に用いる。とりあえずpull up/pull downとしておく。
* EXTALにPICからクロックを供給する。
* R/W,AS,Eは6809の割り当てそのまま用いる。

と、ここで、CPUを「止める」端子がないことに気づく。68HC11や6809/EのようなHOLD端子はない。どうしようか。

## シングルステップ

とりあえず、１命令実行するごとにNMI掛けて割り込みルーチンの中でキー入力待ちで止めることを考える。

* メモリアクセスで停止を判断する。全サイクル又はブレークポイントアドレスか、
* 停止となると、Eサイクルを再開する前にNMIを落として即割り込みルーチンに入る。
* 割り込みルーチンのメモリアクセスステップをトレースして、レジスタの値を知る。
* レジスタ内容を取り出してシリアルポートに出力した後キー入力待ちに入る。NOP命令置きで止める。プログラムカウンタがぐんぐん進むが、シングルステップの終わりでRTIするので気にしない。命令置きとしてSRAMアクセスさせないようにする。

このやり方は68HC11や6809でも使える。これでHALT-RE0端子を使わずにすむ。

## ブレークポイント

メモリアクセスの最初でアドレスバスの値をPICでチェックする。A0-A15すべてPICで読み込みできるようにアドレスピンを全てつなぐ。RAM48使用が前提となります。

## PICリセット/PICファーム書き込み時の挙動

PICリセット時のMPU/PIC間端子衝突を避ける。

MPUはリセット後3クロックで、アドレスバス・データバスをHi-Zにする。R/Wは1でHi-Zではない。PIC立ち上がり直後で直ちにこの状態にもってゆく。この状態にしてからならA0-A7(PF0-PF7), A8-A15(PD0-PD7), D0-D7(PC0-PC7)すべてHi-Zになる。

## ブートローディング

リセット後3クロック入れて全バスHi-Zになった状態で、直接SRAMにRead/Writeする。

## I/Oポート

クロックストレッチを使う。Eの立ち上がりでクロックを止めてEを延長する。処理完了したらクロックを再開する。MPU Read状態の場合は、次のEの立下りで再度クロックを止めて、データバスを入力モードに切り替える。

クロックストレッチは、シングルステップのNMIレジスタ退避追跡の際にも用いる。

## メモリアクセス制御

SRAMのOE/WEとMPUの制御信号線を直接つながらない。何らかのゲートが必要なので、ram40/48いずれにしても間接型を使う。R/WとEのゲートをSRAM OE,WEとする。命令置きの時はOE,WEはH固定とする。
